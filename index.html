<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Processor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #dropZone { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 20px; }
        #dropZone.dragover { background-color: #e1e1e1; }
        #result { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Receipt Processor</h1>
    <div id="dropZone">Drop your receipt images or PDFs here, or click to select files.</div>
    <button onclick="processReceipts()">Process Receipts</button>
    <div id="result"></div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const resultDiv = document.getElementById('result');
        let files = [];

        // Handle file drop and selection
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            files = Array.from(e.dataTransfer.files);
            displayFiles();
        });

        dropZone.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = 'image/*,application/pdf';
            input.onchange = (e) => {
                files = Array.from(e.target.files);
                displayFiles();
            };
            input.click();
        });

        function displayFiles() {
            resultDiv.innerHTML = `<h3>Selected Files:</h3><ul>${files.map(file => `<li>${file.name}</li>`).join('')}</ul>`;
        }

        async function processReceipts() {
            resultDiv.innerHTML = '<h3>Processing...</h3>';
            const apiKey = 'AIzaSyDID5ib0eHNVrBYG0e5vfWQ9RkVinX4hNg'; // Replace with your Google Vision API Key
            const results = [];

            for (const file of files) {
                const base64 = await convertFileToBase64(file);
                try {
                    const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            requests: [{
                                image: { content: base64.split(',')[1] },
                                features: [{ type: 'TEXT_DETECTION', maxResults: 1 }]
                            }]
                        })
                    });

                    const data = await response.json();
                    const text = data.responses[0]?.fullTextAnnotation?.text || 'No text detected';
                    results.push({ filename: file.name, text });
                } catch (error) {
                    resultDiv.innerHTML += `<p>Error processing ${file.name}: ${error.message}</p>`;
                }
            }

            // Prepare data for Excel
            const wb = XLSX.utils.book_new();
            const wsData = [['Filename', 'Extracted Text']];
            results.forEach(result => {
                wsData.push([result.filename, result.text]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'ReceiptData');
            XLSX.writeFile(wb, `all_receipts_extracted_${new Date().toISOString().split('T')[0]}.xlsx`);

            // Display results
            resultDiv.innerHTML += '<h3>Results:</h3><ul>' + results.map(r => `<li>${r.filename}: <pre>${r.text}</pre></li>`).join('') + '</ul>';
            alert('A single Excel file has been generated with all receipt data.');
        }

        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
